webServerListenAddress: "0.0.0.0:8080"
maximumGracefulShutdownDuration: "10s"
afterPipelineShutdownDelay: "1s"

pipeline: ["tailer", "eventFilter", "normalizer", "dynamicClassifier", "statisticalClassifier", "sloEventProducer", "prometheusExporter"]

modules:

  tailer:
    tailedFile: "/tmp/szn-logy/access_log"
    follow: true
    reopen: true
    positionFile: ""
    positionPersistenceInterval: "2s"
    loglineParseRegexp: '^(?P<ip>[A-Fa-f0-9.:]{4,50}) \S+ \S+ \[(?P<time>.*?)\] "(?P<request>.*?)" (?P<statusCode>\d+) \d+ "(?P<referer>.*?)" uag="(?P<userAgent>[^"]+)" "[^"]+" ua="[^"]+" rt="(?P<requestDuration>\d+(\.\d+)??)".+ignore-slo="(?P<ignoreSloHeader>[^"]*)" slo-domain="(?P<sloDomain>[^"]*)" slo-app="(?P<sloApp>[^"]*)" slo-class="(?P<sloClass>[^"]*)" slo-endpoint="(?P<sloEndpoint>[^"]*)" slo-result="(?P<sloResult>[^"]*)"'
    emptyGroupRE: '^-$'

  prometheusIngester:
    apiUrl: "https://thanos.sklik-scif-ko.dev.dszn.cz"
    queryTimeout: 10s
    queries:
      - query: 'time() - last_successful_run_timestamp - on(app) group_left() min(alerting_threshold:last_successful_run_timestamp) by (app) > 0'
        interval: 20s
        dropLabels:
          - job
        additionalLabels:
          purpose: "to_demonstrate_slo_exporter_conf_syntax"

  eventFilter:
    metadataFilter:
      "(?i)statusCode": "30[12]|40[045]|411"
      "(?i)userAgent": "(?i)(?:sentry|blackbox-exporter|kube-probe)"

  normalizer:
    getParamWithEventIdentifier: "operationName"
    replaceRules:
      - regexp: "/api/v1/ppchit/rule/[0-9a-fA-F]{5,16}"
        replacement: "/api/v1/ppchit/rule/0"
      - regexp: '/campaigns/\\d+/groups/\\d+/placements/automatic/(\\w[\\w-]+\\.)+\w{2,}/urls'
        replacement: "/campaigns/0/groups/0/placements/automatic/:domain/urls"
      - regexp: "/api/v1/captchas/\\w+"
        replacement: "/api/v1/captchas/:hash"
    sanitizeHashes: true
    sanitizeNumbers: true
    sanitizeUids: true
    sanitizeIps:     true
    sanitizeImages:  true
    sanitizeFonts:   true

  dynamicClassifier:
    exactMatchesCsvFiles: []
    regexpMatchesCsvFiles:
      - "conf/userportal.csv"
    unclassifiedEventMetadataKeys:
      - "userAgent"

  statisticalClassifier:
    historyWindowSize: "30m"
    historyWeightUpdateInterval: "1m"
    defaultWeights:
      - weight: 1
        classification:
          sloDomain: "userportal"
          sloClass: "test1"

  sloEventProducer:
    rulesFiles:
      - "conf/slo_rules.yaml"

  prometheusExporter:
    metricName: "slo_events_total"
    maximumUniqueEventKeys: 1000
    ExceededKeyLimitPlaceholder: "cardinalityLimitExceeded"
    labelNames:
      result: "result"
      sloDomain: "slo_domain"
      sloClass: "slo_class"
      sloApp: "slo_app"
      eventKey: "event_key"
