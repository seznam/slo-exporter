stages:
  - check
  - build
  - build-ci-release-docker
  - release-docker-development
  - kubernetes-config
  - kubernetes-deploy
  - pages
  - release-docker-production

image: docker.dev.dszn.cz/golang-build:stretch

.ci_scripts_image: &ci_scripts_image
  image: docker.dev.dszn.cz/generic/ci-scripts:1

variables:
  DOCKER_NAMESPACE: sklik-devops
  KUBERNETES_NAMESPACE: sklik-devops-sandbox
  CI_SCRIPTS_ARCHIVE_URL: https://generic.gitlab.seznam.net/ci-scripts/v1/all.tar.gz

lint:
  stage: check
  script: |
    make lint

test:
  stage: check
  script: |
    make test-and-coverage
  artifacts:
    paths:
      - coverage.out
    expire_in: 1 week
    when: always

e2e-test:
  stage: check
  script: |
    make e2e-test
  artifacts:
    paths:
      - test/**/test_ouput
    expire_in: 1 week
    when: always


test-tag-version:
  <<: *ci_scripts_image
  stage: check
  script: |
    /ci/test-version-match.sh
  only:
    - /^v[0-9]+\.[0-9]+\.[0-9]+/


build:
  stage: build
  before_script:
    - curl ${CI_SCRIPTS_ARCHIVE_URL} | tar -xz -C /
    - source /ci/common.sh
    - export SLO_EXPORTER_VERSION=$(get_version)
  script: |
    make build
  artifacts:
    paths:
      - slo_exporter
    expire_in: 1 week

build-ci-release-docker:
  <<: *ci_scripts_image
  stage: build-ci-release-docker
  script: |
    /ci/docker-build.sh --namespace $DOCKER_NAMESPACE
    /ci/docker-release-ci.sh --namespace $DOCKER_NAMESPACE --extra-tags "$CI_COMMIT_REF_NAME"
  dependencies:
    - build
  artifacts:
    expire_in: 1 mos
    paths:
      - docker-release-ci.uri

release-docker-development:
  <<: *ci_scripts_image
  stage: release-docker-development
  only:
    - /^v[0-9]+\.[0-9]+\.[0-9]+/
  except:
    - branches
  script: |
    EXTRA_TAGS="$(/ci/latest-tags.sh)"
    /ci/docker-release.sh --namespace $DOCKER_NAMESPACE --extra-tags "$EXTRA_TAGS"
  artifacts:
    expire_in: 3 mos
    paths:
      - docker-release.uri
      - docker-release.digest


# kubernetes configuration
# ---------------------------------------------------------------------------
.kubernetes-config: &kubernetes-config
  <<: *ci_scripts_image
  stage: kubernetes-config
  environment:
    name: kubernetes-config
  script: |
    /ci/kubernetes-ci-init.sh
    ARGS=()
    for i_slo_exporter_instance in skweb{1,2}-{ko,ng}; do
      [ -f "conf/${ENVIRONMENT}-userportal.env" ] && ARGS+=("--env-file" "conf/${ENVIRONMENT}-userportal.env")
      /ci/kubernetes-config-custom.sh --app slo-exporter-userportal-${i_slo_exporter_instance} --destination-dir kubernetes/${ENVIRONMENT}-slo-exporter-userportal-${i_slo_exporter_instance} --env-file conf/${i_slo_exporter_instance}.include.env --no-configmap "${ARGS[@]}"
    done
  artifacts:
    expire_in: 3 mo
    name: kubernetes-config
    paths:
      - ./kubernetes/${ENVIRONMENT}*/*.yaml

kubernetes-development-config:
  <<: *kubernetes-config
  variables:
    ENVIRONMENT: development
  before_script:
    - export DOCKER_IMAGE=$(cat docker-release.uri docker-release-ci.uri 2>/dev/null | head -1)

kubernetes-production-config:
  <<: *kubernetes-config
  variables:
    ENVIRONMENT: production
  before_script:
    - export DOCKER_IMAGE=$(/ci/production-docker-image-name.sh "$(cat docker-release.uri docker-release-ci.uri 2>/dev/null | head -1)")


kubernetes-deploy:
  <<: *ci_scripts_image
  stage: kubernetes-deploy
  variables:
    ENVIRONMENT: development
  environment:
    name: tt-k8s1.ko
  script: |
    /ci/kubernetes-ci-init.sh
    for i_env in ${ENVIRONMENT}-slo-exporter-userportal-skweb{1,2}-{ko,ng}; do
      /ci/kubernetes-deploy.sh --namespace "${KUBERNETES_NAMESPACE}" --env "${i_env}"
    done
  dependencies:
    - kubernetes-development-config
  only:
    - master
    - /^v[0-9]+\.[0-9]+\.[0-9]+/

pages:
  stage: pages
  dependencies:
    - test
  only:
    - master
  script: |
    mkdir public
    ./scripts/generate_godoc.sh public/godoc
    go tool cover -html coverage.out -o public/coverage.html
    cat > public/index.html <<EOF
    <h1>SLO exporter</h1>
    <ul>
      <li><a href="godoc/pkg/gitlab.seznam.net/sklik-devops/slo-exporter">GoDoc</a></li>
      <li><a href="coverage.html">Code coverage</a></li>
    </ul>
    EOF
  artifacts:
    expire_in: 1 mos
    paths:
      - public


# Release docker image to production registry
# ---------------------------------------------------------------------------
release-docker-production:
  <<: *ci_scripts_image
  stage: release-docker-production
  except:
    - branches
  only:
    - /^v[0-9]+\.[0-9]+\.[0-9]+/
  script: |
    /ci/docker-release-to-production-registry-dirt.sh --docker-image-name-file docker-release.uri --docker-image-digest-file docker-release.digest
